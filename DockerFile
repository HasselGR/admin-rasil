# Imagen base que ya trae PHP-FPM, Composer y Nginx
FROM richarvey/nginx-php-fpm:latest

# Establecer el directorio de trabajo
WORKDIR /var/www/html

# Copiar primero los archivos de composer para aprovechar cache
COPY composer.json composer.lock ./

# Instalar dependencias de PHP (sin dev para producción)
RUN composer install --no-dev --optimize-autoloader --no-interaction --no-progress

# Ahora copiar todo tu proyecto Laravel
COPY . .

# Dar permisos a storage y bootstrap/cache para que Laravel pueda escribir
RUN chown -R nginx:nginx /var/www/html \
    && chmod -R 775 storage bootstrap/cache

# Variables de entorno: APP_KEY, APP_ENV, DB_* se configuran en Render, no aquí.
ENV APP_ENV=production

# Exponer el puerto 80 (Nginx ya sirve /public)
EXPOSE 80

# El contenedor se arranca automáticamente con Nginx+PHP-FPM gracias a la imagen base